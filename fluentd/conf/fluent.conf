# Fluent Bit からのログを受信
<source>
  @type forward
  port 24224
  bind 0.0.0.0
  # タグの追加
  <transport tls>
    cert_path /fluentd/certs/cert.pem
    private_key_path /fluentd/certs/key.pem
    # TLS無効化（テスト環境の場合）
    insecure true
  </transport>
</source>

# 受信ログの確認用（デバッグ）
<match **>
  @type copy
  <store>
    @type stdout
  </store>
  <store>
    @type opensearch
    host opensearch
    port 9200
    scheme http
    ssl_verify false
    
    # インデックス設定
    logstash_format true
    logstash_prefix kubernetes
    logstash_dateformat %Y.%m.%d
    include_timestamp true
    
    # 認証設定（OpenSearch 2.x では必要）
    user admin
    password jaileon02
    
    # バッファ設定
    <buffer>
      @type file
      path /fluentd/buffer/kubernetes
      flush_mode interval
      flush_interval 10s
      flush_thread_count 2
      chunk_limit_size 5M
      queue_limit_length 32
      retry_max_interval 30
      retry_forever false
      retry_max_times 10
      overflow_action drop_oldest_chunk
    </buffer>
    
    # エラーハンドリング
    <secondary>
      @type file
      path /fluentd/failed/kubernetes
    </secondary>
  </store>
</match>
